# builder-bot

Telegram бот для получения заказов на различную спецтехнику.</br>
Бот является дополнительной площадкой для получения заказов и логическим продолжением Android
приложения ["Строитель"](https://play.google.com/store/apps/details?id=com.builders).</br>
База с заказами находится в [Google Firebase](https://firebase.google.com).
Бот забирает из этой БД новые заказы и отправляет их пользователям.

**Как работает бот:**

- Пользователь выбирает тип спецтехники, на которую хочет получать заказы
- Сначала пользователю доступно определенное кол-во бесплатных просмотров номера телефона заказчика
- После истечения кол-ва бесплатных просмотров, пользователю предлагается приобрести платную подписку на эту
  спецтехнику (неделя/месяц/год)
- После приобретения платной подписки пользователь получает новые заказы сразу с открытым номером телефона заказчика
- На каждый тип спецтехники подписка приобретается отдельно
- Также в боте есть связь с поддержкой

**Повтор автоплатежей:**

Теперь при неудачном автоплатеже будет выполнено еще несколько попыток автосписания средств. Пользователь
сможет пополнить баланс карты и дождаться следующего автоматического списания средств, при этом ему нет необходимости
завершать текущую подписку и оформлять ее заново.

- Если статус автоплатежа **canceled**, то выполняем повтор автоплатежа **через 2 дня и через 5 дней**. Также оповещаем
  пользователя, что автоплатеж не прошел и будет выполнено еще две попытки
- После каждого неудачного автоплатежа пользователь будет получать соответствующее уведомление
- Если пользователь отменил подписку после неудачного автоплатежа (штатного или повторного), то следующий автоплатеж
  выполнен не будет
- После **второго** неудачного автоплатежа у пользователя будет закрыта текущая подписка **(AutoPay -> Expired)** и
  создана новая подписка в статусе **Trial**. Соответственно он продолжит получать заказы, но не сможет посмотреть номер
  телефона. Пользователь сможет управлять своей подпиской и в любой момент ее отменить или оформить платную

**Восстановление подписок после блокировки бота пользователем:**

Если пользователь заблокировал бота:

- Если подписка пробная, то проставляем в БД статус **Pause**, чтобы потом при возвращении в бота
  восстановить эту подписку. Также удаляем ID пользователя из рассылки в **Redis**.
- Если подписка платная, то удаляем **ТОЛЬКО** ID пользователя из рассылки в **Redis**.

При возвращении пользователя обратно в бота будут восстанавлены все активные подписки (платные/триальные) и
пользователь сразу начнет получать заказы на все виды спецтехники, на которые был подписан. Для пробных подписок будет
смена статуса в БД (**Pause** -> **Trial**) + добавление ID пользователя в рассылку в **Redis**, а для платных подписок **ТОЛЬКО** добавление ID пользователя в рассылку в **Redis**

**Stack:**

- БД c заказами Firebase (Бот обращается к ней по REST API с
  использованием [StructuredQuery](https://firebase.google.com/docs/firestore/reference/rest/v1/StructuredQuery))
- БД SQLite (Хранение пользовательских данных, данных по платежам, подпискам и тд)
- БД Postgres (Используется для хранения информации по заказам и маппинга chatId-messageId-documentId. На postgres были
  переведены только две таблицы, в дальнейшем планируется полноценный переезд)
- NoSQL БД Redis (Хранение различной информации, в основном кэша)
- JMS очередь(В последнем [обновлении](https://github.com/schepach/builder-bot/releases/tag/v1.3.0) перевел все на JMS
  очередь, чтобы быстрей была отправка заказов пользователям)
- Для оплаты подписки используется [ЮKassa](https://yookassa.ru)
- Библиотека [OkHttp](https://square.github.io/okhttp) для работы с REST API

❗️**P.S. Так как кол-во пользователей растет и рано или поздно бот упрется
в [ограничение](https://core.telegram.org/bots/faq#broadcasting-to-users) на кол-во отправляемых сообщений в секунду,
есть идея перевести работу бота на каналы. То есть чтобы бот отправлял заказ один раз в канал с конкретной спецтехникой,
а не каждому пользователю**